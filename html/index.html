<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Fly With Me!</title>
    <style>
      * {
      /*
        border: 1px solid;
      */
      }

      #takeoff-list {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 500px;
        margin: 8px;
      }

      #google-map-view {
        position: absolute;
        top: 0;
        left: 500px;
        right: 0;
        bottom: 0;
        margin: 8px;
      }

      #takeoff-details {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 500px;
        margin: 8px;
      }

      .takeoff-details-name {
      }

      .takeoff-details-description {
        position: absolute;
        left: 0;
        right: 0;
        top: 50px;
      }

      .takeoff {
        position: relative;
        height: 50px;
      }

      .takeoff-name {
        position: absolute;
        left: 50px;
        height: 50px;
        cursor: pointer;
      }

      .exits-image {
        position: absolute;
        width: 50px;
        height: 50px;
      }

      .favourite-image {
        position: absolute;
        top: 0;
        right: 0;
        width: 50px;
        height: 50px;
        cursor: pointer;
      }

      .noaa-image {
        position: absolute;
        top: 0;
        right: 50px;
        width: 50px;
        height: 50px;
        cursor: pointer;
      }

      .gmaps-image {
        position: absolute;
        top: 0;
        right: 100px;
        width: 50px;
        height: 50px;
        cursor: pointer;
      }

    </style>
  </head>
  <body>
    <script src="https://unpkg.com/mithril"></script>
    <script>
      var FWM = {
        googleMap: null,
        searchText: "",
        takeoffs: [],

        // get takeoff data, update if necessary
        updateTakeoffData: () => {
          var lastUpdated = localStorage.getItem("flightlog_last_updated") || 0;
          var now = new Date().getTime();
          var fetchDays = Math.ceil((now - lastUpdated) / 86400000);
          FWM.takeoffs = JSON.parse(localStorage.getItem("flightlog_takeoffs") || "{}");
          if (fetchDays > 5) {
            fetch("https://cors-anywhere.herokuapp.com/http://flightlog.org/?returntype=xml&rqtid=12&d=" + fetchDays, {
              headers: {
                "Origin": null
              }
            })
              .then(response => response.text())
              .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
              .then(data => {
                var starts = data.getElementsByTagName("start");
                console.log("Updated takeoffs:", starts.length);
                for (i = 0; i < starts.length; ++i) {
                  var takeoffId = starts[i].childNodes[0].textContent;
                  var takeoffData = FWM.takeoffs[takeoffId] || {};
                  takeoffData.id = takeoffId;
                  takeoffData.name = starts[i].childNodes[1].textContent;
                  takeoffData.description = starts[i].childNodes[2].textContent;
                  takeoffData.lat = parseFloat(starts[i].childNodes[3].textContent);
                  takeoffData.lng = parseFloat(starts[i].childNodes[4].textContent);
                  takeoffData.wind = parseInt(starts[i].childNodes[5].textContent);
                  takeoffData.alt = parseInt(starts[i].childNodes[9].textContent);
                  takeoffData.altdiff = parseInt(starts[i].childNodes[10].textContent);
                  FWM.takeoffs[takeoffId] = takeoffData;
                }
                localStorage.setItem("flightlog_takeoffs", JSON.stringify(FWM.takeoffs));
                localStorage.setItem("flightlog_last_updated", now);
              });
          }
        },

        // initialize and add the map
        initGoogleMap: () => {
          FWM.googleMap = new google.maps.Map(document.getElementById('google-map-view'), {zoom: 11, center: {lat: 61.87416667, lng: 9.15472222}, mapTypeId: 'terrain'});
          //var marker = new google.maps.Marker({position: rikssenter, map: FWM.googleMap});
          //FWM.googleMap.data.loadGeoJson('https://raw.githubusercontent.com/relet/pg-xc/master/geojson/luftrom.geojson');
        },

        // convert text to html
        textToHtml: (text) => {
          // escape dangerous characters
          text = text.replace(/"/g, "&#34;").replace(/'/g, "&#39;").replace(/</g, "&#60;").replace(/>/g, "&#62;");
          // replace newlines with <br />
          text = text.replace(/\n/g, "<br />");
          // add links to urls
          text = text.replace(/(http:\/\/[^\s]+)/g, "<a href=\"\$1\">\$1</a>");
          return text;
        },

        // pan map to position
        panMap: (position) => {
          console.log("Pan map to:", position);
          FWM.googleMap.panTo(position);
          console.log(FWM.googleMap.getBounds().getNorthEast().lat());
        }
      };

      var takeoffListEntry = {
        view: (vnode) => {
          var takeoff = vnode.attrs.takeoff;
          return m("div", {id: takeoff.id, class: "takeoff", onmouseover: () => {}, onmouseout: () => {}}, [
            m("svg", {class: "exits-image", viewBox: "-105 -105 210 210"}, [
              m("circle", {r: "104", stroke: "black", "stroke-width": "2", fill: "none"}),
              m("path", {visibility: (takeoff.wind & (1 << 7)) != 0 ? "visible" : "hidden", d: "M 0 0 L -38.268 -92.388 A 100 100 0 0 1  38.268 -92.388 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 6)) != 0 ? "visible" : "hidden", d: "M 0 0 L  38.268 -92.388 A 100 100 0 0 1  92.388 -38.268 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 5)) != 0 ? "visible" : "hidden", d: "M 0 0 L  92.388 -38.268 A 100 100 0 0 1  92.388  38.268 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 4)) != 0 ? "visible" : "hidden", d: "M 0 0 L  92.388  38.268 A 100 100 0 0 1  38.268  92.388 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 3)) != 0 ? "visible" : "hidden", d: "M 0 0 L  38.268  92.388 A 100 100 0 0 1 -38.268  92.388 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 2)) != 0 ? "visible" : "hidden", d: "M 0 0 L -38.268  92.388 A 100 100 0 0 1 -92.388  38.268 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 1)) != 0 ? "visible" : "hidden", d: "M 0 0 L -92.388  38.268 A 100 100 0 0 1 -92.388 -38.268 Z", stroke: "none", fill: "#05c70f"}),
              m("path", {visibility: (takeoff.wind & (1 << 0)) != 0 ? "visible" : "hidden", d: "M 0 0 L -92.388 -38.268 A 100 100 0 0 1 -38.268 -92.388 Z", stroke: "none", fill: "#05c70f"})
            ]),
            m("span", {class: "takeoff-name", onclick: () => {FWM.panMap(takeoff)}}, takeoff.name),
            m("svg", {class: "favourite-image", width: "255", height: "240", viewBox: "0 0 51 48"}, [
              m("path", {fill: "none", stroke: "#000", d: "m25,1 6,17h18l-14,11 5,17-15-10-15,10 5-17-14-11h18z"})
            ]),
            m("img", {class: "noaa-image", src: "images/NOAA.svg"}),
            m("img", {class: "gmaps-image", src: "images/GoogleMaps.svg"})
          ]);
        }
      };

      var takeoffList = {
        view: (vnode) => {
          return m("div", {id: "takeoff-list"}, [
            m("input", {oninput: m.withAttr("value", (text) => {FWM.searchText = text}), value: FWM.searchText}),
            m("br"),
            m("div", Object.values(FWM.takeoffs).filter((takeoff) => takeoff.name.match(new RegExp(FWM.searchText, "i"))).slice(0, 10).map((takeoff) => {
              return m(takeoffListEntry, {key: takeoff.id, takeoff: takeoff})
            }))
          ]);
        }
      };

      var main = {
        oninit: (vnode) => {
          FWM.updateTakeoffData();
        },

        view: () => {
          return m("main", [
            m(takeoffList),
            m("div", {id: "google-map-view"})
          ]);
        },
      };

      // mount main
      m.mount(document.body, main);
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCq8s3A3SxPHvjlqagRp_JVcfTgU-lh7mo&callback=FWM.initGoogleMap"></script>
  </body>
</html>
