<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Fly With Me!</title>
    <script src="https://unpkg.com/vue"></script>
    <style>
      #takeoff-list {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 500px;
        margin: 8px;
      }

      #google-map-view {
        position: absolute;
        top: 0;
        left: 500px;
        right: 0;
        bottom: 0;
        margin: 8px;
      }

      .takeoff {
        position: absolute;
        margin: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="flywithme"></div>

    <script id="app" type="text/x-template">
      <div id="main">
        <div id="takeoff-list">
          <input type="text">
          <br>
          <div :id="'takeoff-' + takeoff.id" v-for="takeoff in takeoffs.slice(0, 10)">
           <svg viewBox="-105 -105 210 210" height="50" width="50">
              <circle r="104" stroke="black" stroke-width="2" fill="none" />
              <path v-show="(takeoff.wind & (1 << 7)) != 0" class="n" d="M 0 0 L -38.268 -92.388 A 100 100 0 0 1 38.268 -92.388 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 6)) != 0" class="ne" d="M 0 0 L 38.268 -92.388 A 100 100 0 0 1 92.388 -38.268 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 5)) != 0" class="e" d="M 0 0 L 92.388 -38.268 A 100 100 0 0 1 92.388 38.268 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 4)) != 0" class="se" d="M 0 0 L 92.388 38.268 A 100 100 0 0 1 38.268 92.388 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 3)) != 0" class="s" d="M 0 0 L 38.268 92.388 A 100 100 0 0 1 -38.268 92.388 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 2)) != 0" class="sw" d="M 0 0 L -38.268 92.388 A 100 100 0 0 1 -92.388 38.268 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 1)) != 0" class="w" d="M 0 0 L -92.388 38.268 A 100 100 0 0 1 -92.388 -38.268 Z" stroke="none" fill="#05c70f" />
              <path v-show="(takeoff.wind & (1 << 0)) != 0" class="nw" d="M 0 0 L -92.388 -38.268 A 100 100 0 0 1 -38.268 -92.388 Z" stroke="none" fill="#05c70f" />
            </svg>
            <span class="takeoff" @click="panMap(takeoff.lat, takeoff.lng)">{{ takeoff.name }}</span>
          </div>
        </div>
        <div id="google-map-view"></div>
      </div>
    </script>

    <script>
      var app = new Vue({
        el: '#flywithme',
        data: {
          takeoffs: localStorage.getItem("flightlog_takeoffs") || [],
          googleMap: null
        },
        template: '#app',
        methods: {
          getFlightlogTakeoffs: function() {
            var lastUpdated = localStorage.getItem("flightlog_last_updated") || 0;
            var now = new Date().getTime();
            var fetchDays = Math.ceil((now - lastUpdated) / 86400000);

            if (fetchDays > 5) {
              fetch("https://cors-anywhere.herokuapp.com/http://flightlog.org/?returntype=xml&rqtid=12&d=" + fetchDays, {
                headers: {
                  "Origin": null
                }
              })
                .then(response => response.text())
                .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
                .then(data => {
                  var starts = data.getElementsByTagName("start");
                  console.log("Updated takeoffs:", starts.length);
                  var flightlogTakeoffs = [];
                  for (i = 0; i < starts.length; ++i) {
                    var takeoffData = {
                      id: starts[i].childNodes[0].textContent,
                      name: starts[i].childNodes[1].textContent,
                      description: starts[i].childNodes[2].textContent,
                      lat: parseFloat(starts[i].childNodes[3].textContent),
                      lng: parseFloat(starts[i].childNodes[4].textContent),
                      wind: parseInt(starts[i].childNodes[5].textContent)
                    }
                    flightlogTakeoffs.push(takeoffData);
                  }
                  // TODO: this overwrites existing takeoffs
                  // TODO: we'll also have to handle takeoffs marked as favourites
                  localStorage.setItem("flightlog_takeoffs", JSON.stringify(flightlogTakeoffs));
                  localStorage.setItem("flightlog_last_updated", now);
                  
                  app.takeoffs = JSON.parse(localStorage.getItem("flightlog_takeoffs"));
                });
            }

            app.takeoffs = JSON.parse(localStorage.getItem("flightlog_takeoffs")) || [];
          },

          panMap: function(lat, lng) {
            console.log("Pan to:", lat, lng);
            this.googleMap.panTo({lat: lat, lng: lng});
          }
        }
      });

      app.getFlightlogTakeoffs();

      // Initialize and add the map
      function initMap() {
        app.googleMap = new google.maps.Map(document.getElementById('google-map-view'), {zoom: 11, center: {lat: 61.87416667, lng: 9.15472222}, mapTypeId: 'terrain'});
        //var marker = new google.maps.Marker({position: rikssenter, map: app.googleMap});
      }

      /*
      navigator.geolocation.getCurrentPosition(function(location) {
        console.log(location.coords.latitude);
        console.log(location.coords.longitude);
        console.log(location.coords.accuracy);
      });
      */
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCq8s3A3SxPHvjlqagRp_JVcfTgU-lh7mo&callback=initMap"></script>
    <!--
    <start>
    <id><![CDATA[6246]]></id>
    <name><![CDATA[	Jorde på Løten, Klæpa airport]]></name>
    <description><![CDATA[.]]></description>
    <lat><![CDATA[60.79527778]]></lat>
    <lon><![CDATA[11.34555556]]></lon>
    <wind><![CDATA[56]]></wind>
    <country_id><![CDATA[160]]></country_id>
    <region_id><![CDATA[6]]></region_id>
    <subregion_id><![CDATA[0]]></subregion_id>
    <altitude><![CDATA[180]]></altitude>
    <altitudediff><![CDATA[0]]></altitudediff>
    <createdtime><![CDATA[2014-09-08 00:08:08]]></createdtime>
    <updatedtime><![CDATA[2015-02-01 18:55:20]]></updatedtime>
    </start>
    -->
  </body>
</html>
